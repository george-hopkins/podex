<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-2">
<title>Podex -- rozhraní 68HC12 BDM -- Pøíklad pou¾ití</title>
</head>
<body>
<table border="0" width="100%"><tr>
<td valign="top" align="left"><ul>
<li><a href="index.html">Podex, 68HC12 BDM</a></li>
<li><a href="podex_hw.html">Hardware</a></li>
<li><a href="podex_fw.html">Firmware (program unvitø podexu)</a></li>
<li><a href="podex_gdb.html">Software</a></li>
<li><i>Pøíklad pou¾ití</i></li>
<li><a href="podex_faq.html">ÈKD</a></li>
</ul></td>
<td valign="bottom" align="right">
<h1>Pøíklad pou¾ití</h1>[ <a href="podex_eg.en.html">english</a> ]</td>
</tr></table>
<hr>
<a name="podex_eg"></a>

<p>Jako malinkou ukázeèku pou¾ití podexu uvedu program v C, který
zobrazuje osmibitového svìtelného hada, a postup, jak jej zkompilovat,
nahrát do RAM èi FLASH a ladit. Program pøedpokládá, ¾e na portu PH je
pøipojeno osm svítivek (svítících nejlépe pøi log.1). Byl odzkou¹en na
desce s M68HC912D60A:
</p>
<blockquote><table border="1" cellspacing="0" cellpadding="3"><tr><td><pre>
Krásná fotka desky s pøipojenými LEDkami...
</pre></td></tr></table></blockquote>
<p>Zdrojový text programu
(<a href="sw/eg/ukazka/ukazka.c">ukazka.c</a>)
je zde:</p>
<blockquote><table border="1" cellspacing="0" cellpadding="3"><tr><td><pre>
zdrojááák...
</pre></td></tr></table></blockquote>
<p>Program na zaèátku vlkádá soubor <a href="sw/eg/ukazka/intvec.h">intvec.h</a>, co¾ je definice
pamì»ové struktury interrupt_vectors, opsaná z <a href="http://groups.yahoo.com/group/gnu-m68hc11/message/4010">jednoho
pøíspìvku</a> v <a href="podex_gdb.html#maillist">mailové konferenci</a>.
Pou¾itím této
struktury je pak na zaèátku programu urèena jediná adresa, a sice
zaèátek programu (_start, to je místo ve výsledném kompilátu, kde je
zaèátek v¹ech zaèátkù). Kdyby program pou¾íval obslu¾né procedury
nìjakých pøeru¹ení, bylo by mo¾né je do této struktury pøidat.
Struktura je vlo¾ena do sekce linkeru jménem .vectors, ta je na samém
konci pamìti od adresy 0xff00, kde HC12 hledá adresy kam skákat pøi
hardwarových událostech. Kdo trochu rozumí GNU ld, asi se mi za toto
paøe¹ení vysmìje, proto¾e se to správnì má øe¹it asi jinak -- tak se na
mì nezlobte.
</p>
<p>Dále jsou definovány konstantní ukazatele do vstupnì/výstupního
pamì»ového prostoru, a sice DDRH a PORTH, tedy øízení výstupní brány,
na ní¾ mají být pøipojena svìtélka. Funkce sleep() èeká urèitou chvilku
tisícerým opakováním nièeho, aby had nebìhal moc rychle. Na vìèné
smyèce hlavního programu není celkem nic zvlá¹tního, a¾ na paskvilní
vyjádøení zámìru orotovat osm bitù, které (alespoò v souèasné verzi)
kupodivu gcc nezoptimalizuje na rotaci, ale ubo¾ák tam nacpe tu hrùzu
doslova. Pokud to nìkoho trápí, mù¾e si jistì do zdrojáku vlo¾it kus
assembleru.
</p>
<p>V pøípadì spou¹tìní z FLASHe (tj. samoèinnì po zapnutí napájení) je
je¹tì pøedefinována funkce __premain (ta se spou¹tí pøed prvním voláním
funkce, tedy pøed voláním main()). V ní je nejprve zakázán zlý hlídací
pes COP, proto¾e vinou chyby nìkterých HC12 jinak maøí funkci programù,
ov¹em zejména je zde pøemapována pamì» RAM z pùvodní adresy 0x000 (kde
je ne¹ikovnì pøekryta registry) na adresu 0x800 a dále je o stejnou
velikost zvìt¹en zásobník, aby ukazoval na novì umístìnou pamì» a ne do
díry po ní.
</p>
<p>Aby linker ld vìdìl, v jakých adresních rozsazích se má výsledek
vyskytovat, je mu to tøeba sdìlit, napøíklad tzv. ld-skriptem. Pro
práci èistì v RAM slou¾í skript <a href="sw/eg/ukazka/ram.x">ram.x</a>,
pro umístìní programu do FLASH skript <a href="sw/eg/ukazka/flash.x">flash.x</a>. O kompilaci se stará <a href="sw/eg/ukazka/Makefile">Makefile</a>.
V¹echny soubory je mo¾né stáhnout <a href="sw/eg/ukazka/">zde</a>,
zabalené <a href="sw/eg/ukazka.tar.gz">zde</a>.
</p>
<p>Pokud chci zapsat program do pamìti FLASH, aby se spustil
sám po resetu HC12, provedu
</p>
<blockquote><table border="1" cellspacing="0" cellpadding="3"><tr><td><pre>
$ make FLASH=cp -f flash.x memory.xm68hc12-gcc -Os -O3 -gstabs -Wl,-m,m68hc12elfb -DFLASH -o ukazka.elf ukazka.c/tmp/ccOkA8sJ.s: Assembler messages:/tmp/ccOkA8sJ.s:41: Warning: setting incorrect section attributes for .vectors$ m68hc12-gdb ukazka.elfGNU gdb 6.0-m68hc1x-2004-02-01Copyright 2003 Free Software Foundation, Inc.GDB is free software, covered by the GNU General Public License, and you arewelcome to change it and/or distribute copies of it under certain conditions.Type "show copying" to see the conditions.There is absolutely no warranty for GDB.  Type "show warranty" for details.This GDB was configured as "--host=i686-pc-linux-gnu --target=m68hc11-elf"...(gdb) target bdm12 ttyS0 4 0x0 0x800 0xd00 0x8000(gdb) load ukazka.elf
</pre></td></tr></table></blockquote>
<blockquote><table border="1" cellspacing="0" cellpadding="3"><tr><td><pre>
Sem by se hodila taky nìjaká foteèka...
</pre></td></tr></table></blockquote>
<p>Pokud chci program nahrát do RAM a trochu ladit, mohu psát tøeba</p>
<blockquote><table border="1" cellspacing="0" cellpadding="3"><tr><td><pre>
$ makecp -f ram.x memory.xm68hc12-gcc -Os -O3 -gstabs -Wl,-m,m68hc12elfb  -o ukazka.elf ukazka.c$ m68hc12-gdb ukazka.elfGNU gdb 6.0-m68hc1x-2004-02-01Copyright 2003 Free Software Foundation, Inc.GDB is free software, covered by the GNU General Public License, and you arewelcome to change it and/or distribute copies of it under certain conditions.Type "show copying" to see the conditions.There is absolutely no warranty for GDB.  Type "show warranty" for details.This GDB was configured as "--host=i686-pc-linux-gnu --target=m68hc11-elf"...(gdb) target bdm12 ......
</pre></td></tr></table></blockquote>
<p></p>
<br><hr size="1">
<table border="0" width="100%"><tr>
<td align="left"><em>Podex -- rozhraní 68HC12 BDM</em></td>
<td align="center"><a href="http://duch.cz/podex/">http://duch.cz/podex/</a></td>
<td align="right">
<em>Marek Peca,</em> &lt;<a href="mailto:marek@duch.cz">marek@duch.cz</a>&gt;</td>
</tr></table>
</body>
</html>
