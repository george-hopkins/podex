<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-2">
<title>Podex -- rozhraní 68HC12 BDM -- Software</title>
</head>
<body>
<table border="0" width="100%"><tr>
<td valign="top" align="left"><ul>
<li><a href="index.html">Podex, 68HC12 BDM</a></li>
<li><a href="podex_hw.html">Hardware</a></li>
<li><a href="podex_fw.html">Firmware (program unvitø podexu)</a></li>
<li>
<i>Software</i><ul>
<li>
<a href="podex_gdb.html#4-1">Podex a GNU gdb</a><ul>
<li><a href="podex_gdb.html#4-1-1">Jak získat gdb pro podex?
</a></li>
<li><a href="podex_gdb.html#4-1-2">Základní úkony s podexem v gdb</a></li>
<li><a href="podex_gdb.html#4-1-3">Programování pamìtí FLASH</a></li>
<li><a href="podex_gdb.html#gdb-flash">FLASH a gdb</a></li>
<li><a href="podex_gdb.html#4-1-5">Zaèlenìní programovací rutiny do souèasného (neutì¹eného) kódu
  v gdb</a></li>
</ul>
</li>
<li><a href="podex_gdb.html#4-2">gcc a binutils pro HC11, HC12</a></li>
</ul>
</li>
<li><a href="podex_eg.html">Pøíklad pou¾ití</a></li>
<li><a href="podex_faq.html">ÈKD</a></li>
</ul></td>
<td valign="bottom" align="right">
<h1>Software</h1>[ <a href="podex_gdb.en.html">english</a> ]</td>
</tr></table>
<hr>
<a name="podex_gdb"></a>

<a name="4-1"></a><h2>Podex a GNU gdb</h2>

<p>Podex je urèen zejména pro práci s vynikajícím GNU debuggerem gdb.
Gdb ve spolupráci s podexem umo¾òuje nahrávání kódu do RAM i FLASH
procesorù HC12, spou¹tìní a krokování programù, pou¾ívání breakpointù
apod. s prací na úrovni assembleru i vy¹¹ího jazyka (C). Pou¾il jsem
gdb ve spolupráci s 68HC1x odno¾í GNU gcc a binutils, ale v principu by
mìl GNU gdb pracovat i s výstupy z jiných kompilátorù. Podporovány jsou
formáty souborù ELF, S-record, binární bez záhlaví, jako¾ i ostatní z
knihovny bfd, pro ladìní na úrovni vy¹¹ího jazyka formát stabs (a mo¾ná
nejen ten).
</p>
<a name="4-1-1"></a><h3>Jak získat gdb pro podex?
</h3>

<p>Podporu pro protokol BDM12 Kevina Rosse pøidal do 68HC1x odno¾e gdb
Timothy Housel. V dobì tvorby podexu (duben 2004) byla k dispozici
68HC1x úprava gdb-6.0 oznaèená 20040222 (<a href="http://ftp.gnu.org/pub/gnu/gdb/gdb-6.0.tar.gz">gdb-6.0.tar.gz</a> [<a href="sw/gdb/gdb-6.0.tar.gz">místní záloha</a>],
<a href="http://m68hc11.serveftp.org/m68hc1x-builder-2.91.tar.gz">m68hc1x-builder-2.91.tar.gz</a>
[<a href="sw/gdb/m68hc1x-builder-2.91.tar.gz">místní záloha</a>]).
Doporuèuji pou¾ít na zdrojový kód BDM12 podpory v
gdb malou záplatu, která odstraòuje jednu chybu soubìhu a zároveò
natáhne nìkteré èasové konstanty, co¾ se ukázalo být nutností zejména
pøi pou¾ití USB pøevodníku na RS232 nebo pøi zátì¾i systému. (Záplata
zatím nebyla zaèlenìna do 68HC1x odno¾e gdb, je ji mo¾no stáhnout
<a href="sw/gdb/gdb-bdm12-mp.diff">zde</a>.)
</p>
<p>GNU gdb je urèen zejména k pou¾ití v unixových systémech, ale
podpora BDM12, co¾ se týká pøístupu k linkám RTS, CTS sériového portu,
je psána s ohledem na pou¾ití v unixové GNU nadstavbì Gygwin32/Mingw32
ubohého pasystému M$ Windows. Pro kompilaci gdb si stáhnìte uvedené
zdrojové balíky, oficiální zdroják GNU <tt>gdb-6.0.tar.gz</tt>,
vìtev 68HC1x <tt>m68hc1x-builder-2.91.tar.gz</tt> a záplatu
<tt>gdb-bdm12-mp.diff</tt>. Poté rozbalte, slepte a zkompilujte:
</p>
<blockquote><table border="1" cellspacing="0" cellpadding="3"><tr><td><pre>
tar xzvf gdb-6.0.tar.gz
tar xzvf m68hc1x-builder-2.91.tar.gz
cd gdb-6.0
patch -p1 &lt; ../m68hc1x-builder-2.91/gdb-6.0-m68hc1x-20040222.diffs
patch -p1 &lt; ../gdb-bdm12-mp.diff

./configure --target=m68hc11-elf --program-prefix=m68hc12-
make
#pøípadnì pak s právy roota make install (implicitnì do /usr/local/...)
</pre></td></tr></table></blockquote>
<p>Doporuèuji pøipravit si pro práci i 68HC1x odno¾ GNU gcc a binutils
(vèetnì assembleru gas). Ty ov¹em bývají èasto zahrnuty ji¾ pøipravené
v distribucích GNU (napø. Debian Linux), co¾ vás mù¾e u¹etøit kompilace.
</p>

<a name="4-1-2"></a><h3>Základní úkony s podexem v gdb</h3>

<p>Práce s podexem se v gdb zahajuje pøíkazem target bdm12:</p>
<blockquote><table border="1" cellspacing="0" cellpadding="3"><tr><td><pre>
(gdb) target bdm12
Usage: target bdm12 &lt;serial_device&gt; &lt;E-clock rate (1,2,4, or 8 MHz)
                            &lt;register base&gt; &lt;ram base&gt; &lt;eeprom base&gt; &lt;flash base&gt;
(ex. target bdm12 com1 8 0x0 0x800 0xd00 0x8000 on Win32,
   or target bdm12 ttya 8 0x0 0x800 0xd00 0x8000 on UNIX)
</pre></td></tr></table></blockquote>
<a name="gdb-target"></a>
<p>Kde serial_device je jméno sériového zaøízení, na nì¾ je pøipojen
podex, co¾ mù¾e být v Linuxu napøíklad ttyS? pro bì¾ný COM port PC nebo
ttyUSB? pøi pou¾ití pøevodníku na USB. Pozor, v souèasné verzi pøidává
BDM12 kód v unixu sám pøedponu "/dev/" k jménu zaøízení, co¾ sice
u¹etøí písaøce 5 úhozù, ale je to omezující a pøi nejbli¾¹í
pøíle¾itosti by to chtìlo z gdb vyndat. E-clock_rate je frekvence BDM
sbìrnice cílové HC12, ov¹em v souèasné verzi je omezena na 4
celoèíselné hodnoty, nebo» pou¾ívá pouze firmwarový pøíkaz
<a href="podex_fw.html#p-set-param">SetParam</a>
(zde opìt doufám, ¾e co nevidìt doplníme podporu pro HC12
o libovolných kmitoètech, pou¾ívající firmwarový pøíkaz
<a href="podex_fw.html#p-extended-speed">ExtendedSpeed</a>).
</p>
<p>Argument register_base informuje podex o tom, ¾e registry budou
pøípadnì nìkam pøesunuty, viz firmwarový pøíkaz
<a href="podex_fw.html#p-set-register-base">SetRegisterBase</a>.
O umístìní základních vnitøních pamìtí, tj. 2KB RAM,
32KB FLASH a 768B EEPROM, øíkají argumenty ram_base, eeprom_base a
flash_base. Jak øe¹it nepøeberné pøípady rùzného mno¾ství rùznì velkých
vnitøních i vnìj¹ích pamìtí rùzných typù (RAM, FLASH) u HC12, v tom
nemám jasno a asi by bylo dobré se podívat do snad pokroèilej¹ího kódu
gdb pro jiné procesory.
</p>
<p>Chceme-li ladit program z binárního souboru, který obsahuje ladicí
informace (jména funkcí, promìnných, èísla øádkù v zdrojovém kódu),
uvedeme jej buï jako argument pøi spou¹tìní gdb nebo jej mù¾eme naèíst
pozdìji pøíkazem file.
</p>
<p>Program do procesoru HC12 se nahrává pøíkazem load (rozsáhlej¹í
úseky dat zøejmì pøíkazem restore, ale to jsem zatím nezkou¹el). To je
vùbec nejdùle¾itìj¹í a zároveò nejzapeklitìj¹í úkon s podexem v gdb.
Program (data) lze toti¾ zapsat jak do pamìti RAM, tak do EEPROM a
zejména FLASH, kterou gdb prostøednictvím podexu a postupu popsaného
dále naprogramuje. Tak lze pou¾ít gdb jako programátor vnitøních pamìtí
FLASH HC12. Vlastnosti a úskalí zapisování do FLASH jsou popsány v
dal¹í èásti.
</p>
<p>Je-li program nahrán v nìkteré z pamìtí HC12, v nejjednodu¹¹ím
pøípadì v RAM, mù¾e být z gdb spou¹tìn, krokován, zastavován a jinak
trápen. Breakpointy je mo¾né nastavit pøíkazem break, a to na úrovni
èísla øádku (break 33 èi break trabant_svicky.c:1811), jména funkce
(break pridej_plyn) èi adresy v pamìti (break *0x8a0d). Program je
spu¹tìn pøíkazem run, pøeru¹uje se stiskem Ctrl-C. Pokraèovat je mo¾né
pøíkazem continue, krokovat na úrovni zdrojového kódu pøíkazy step
(dùslednì i s vnoøováním do funkcí), next (na dal¹í øádek), until
apod., na úrovni instrukcí strojového kódu pøíkazy stepi, nexti (nexti
opìt nekrokuje v podprogramech).
</p>
<p>Z gdb je rovnì¾ mo¾né hrabat se HC12 v registrech a v pamìti, obsah
v¹ech (¾e jich je teda u HC12 hodnì) registrù je vypsán pøíkazem regs,
do registru se zapisuje pøíkzem set (set $d=-1977, set $pc=0x8000),
kterým je té¾ mo¾no zapsat do pamìti, a» u¾ do promìnné (set
tachometr=0) èi na libovolnou adresu (set *0x804=0xbaba). Mo¾ná projde
i zápis do pamìti FLASH, ale nejsem si teï zcela jist, jestli pøi tom
souèasná verze BDM12 podpory v gdb neznièí obsah RAM. Èíst samostatné
registry, promìnné èi pamì» je mo¾né pøíkazem print (print $x, print
*0x806, print motor-&gt;valec[1]). Pro výpis jednotlivých míst v pamìti
se hodí pøíkaz x (examine), ukazující obsah v rùzných èíselných soustavách
a rùzné bitové délky (x/b *0x808 uká¾e slabiku z dané adresy,
x/h *0x808 uká¾e z dané adresy 16bitové slovo). Pokud vás popadne
dùvodné podezøení èi paranoia, a to se stává pøi ladìní velmi èasto,
mù¾ete si nechat vypsat v instrukcích obsah pamì»ového úseku èi funkce
pøíkazem disassemble (disassemble _start, disassemble uber_plyn,
disassemble 0x802c 0x8100, bez argumentu vypí¹e funkci, v ní¾ se zrovna
HC12 nalézá).
</p>
<p>GNU gdb je mocná pøí¹era a pro zji¹tìní mo¾ností jeho pou¾ití s
podexem (i mimo nìj) se obra»te na jeho pøíkaz help | pokus&amp;omyl |
dokumentaci | èetbu zdrojákù. Pøíjemnou zábavu!
</p>
<p>Funkce pro podporu BDM12 (a tím i podexu) Tima Housela v GNU gdb
jsou v souboru bdm12.c, definice konstant a deklarace v souboru
bdm12.h, to celé je spojeno s hlavním programem gdb souborem
remote-bdm12.c. Pro úèely zápisu do pamìti FLASH slou¾í soubory
bdm12_eraseflash.h a bdm12_programflash.h.
</p>

<a name="4-1-3"></a><h3>Programování pamìtí FLASH</h3>

<p>Vnitøní pamìti FLASH procesorù HC12 se ètou jako be¾ná pamì», stejnì
jako RAM a EEPROM, a» u¾ libovolnými instrukcemi strojového kódu, nebo
prostøednictvím BDM pøíkazy READ_BYTE, READ_WORD. K zápisu do nich je
ov¹em tøeba trochu zakouzlit s øídicími registry HC12 a pohlídat
èasování, stejnì jako u pamìti EEPROM. Narozdíl od pamìti EEPROM je
ov¹em není mo¾no programovat pouhým pou¾itím BDM pøíkazù pro zápis (do
øídicích registrù a do pamìti). K zápisu do vnitøních pamìtí FLASH
procesorù HC12 je tøeba nahrát do (RAM) HC12 program, který provádí
zápis do FLASH, a spustit jej.
</p>
<p>Zlá je skuteènost, ¾e vnitøní pamìti rùzných modelù HC12 se z
programátorského hlediska navzájem li¹í a nejspí¹ není mo¾né jedním
univerzálním programem zapisovat do FLASH v¹ech odrùd HC12. Pán z
Motoroly mì ale utì¹oval, ¾e u øady HCS12 u¾ se pouèili a pou¾ili
jednotný pøístup ke v¹em FLASHkám, tak aspoò ¾e vývoj nejde v¹ude jen
dozadu, jako od pìstního klínu k mobilnímu telefonu. Na druhou stranu
ale bude stejnì v¹ude plno rùzných vývojových desek s vnìj¹ími pamìtmi
FLASH, tak¾e budeme-li chtít pøes BDM programovat i je, budeme opìt
potøebovat pro ka¾dou jiný kód.
</p>
<p>Programování FLASH HC12 probíhá tak, ¾e se nejprve nahraje nìkam do
RAM mazací program, jeho¾ spu¹tìním je celá FLASH smazána. Poté se
nahraje do RAM zapisovací program, a do zbylé volné RAM se v¾dy nahraje
úsek dat, který je po pøedání parametrù (umístìní úseku v cílové FLASH
a jeho délka) zapisovacímu programu do FLASH naprogramován. Vyvolávání
zapisovacího programu se opakuje pro ka¾dý dal¹í úsek dat, dokud není
zapsáno v¹e. Nahrání programù i dat do RAM, jejich spou¹tìní a pøedání
parametrù (registrem èi místem v RAM) se dìje prostøednictvím BDM, po
ukonèení èinnosti programy obvykle vyvolají instrukci BGND, co¾ se
zjistí opìt pøes BDM ètením stavového registru. Programùm je rovnì¾
tøeba nìjak sdìlit èasovací konstantu, nebo» èasování pøístupu k FLASH
je v programech odvozeno z taktu HC12.
</p>

<a name="gdb-flash"></a><h3>FLASH a gdb</h3>

<p>Souèasná podpora programování FLASH v gdb je ¾alostná. Tim Housel
vlo¾il do souborù bdm12_eraseflash.h a bdm12_programflash.h rutiny pro
programování FLASH odrùdy M68HC12B32, bohu¾el navíc s pevnì danou
frekvencí HC12 (pevnými èasovými konstantami). Viz jejich zdrojový
kód. Tento kód bez úprav tedy naprogramuje nejspí¹e pouze HC12B32 s
krystalem 16MHz.
</p>
<p>Jak z toho ven? Nejlep¹ím øe¹ením by bylo mít
</p>
<ul>
<li>jednotné rozhraní pro volání mazacích a zapisovacích programù,
tj. urèené spou¹tìní, pøípadnì relokaci, pøedání parametrù -- adresy
cíle, pøípadì i zdroje dat, délky úseku a taktovací frekvence procesoru
  </li>
<li>sadu (spousty) mazacích a zapisovacích rutin dynamicky
nahrávaných ze souboru, umístìných mimo kód samotného gdb, kdykoli
u¾ivatelem upravitelných èi doplnitelných</li>
</ul>
<p>Takové øe¹ení pou¾ívá napøíklad <a href="http://www.pemicro.com/support/flash_list_menu.cfm">P&amp;E pro HC12</a>,
<a href="index.html#pavel-pisa">Pavel Pí¹a pro M683xx</a>.
Otázkou je, jaký formát pro vnìj¹í
dynamicky nahrávané prográmky zvolit, mo¾ná by nebyl od vìci ELF, v
nìm¾ u¾ je vyøe¹eno pojmenování symbolù a relokace -- je to ale na
druhou stranu potvora slo¾itá, není nad prostou krásu binárního soboru
bez hlavièky... Dále by nebylo ¹patné zkontrolovat, jestli v jiné èásti
gdb pro jiné procesory u¾ nìkdo nìjaký systém dynamického nahrávání
modulù nepou¾ívá, aby byly pøípadnì snahy sjednoceny. Rád bych se do¾il
takové pru¾né a úèinné podpory FLASHování HC12 v gdb a sám bych na tom
rád, dovolí-li èas, pracoval, ale momentálnì mám hodnì jiné práce a tak
doufám, ¾e se nìkdo se svou snahou pøipojí.
</p>
<p>Prozatímním øe¹ením by mohlo být definování jednoduchého
bezhlav(ièkov)ého rozhraní, obdobného kódu Tima Housela, kde by byly
urèeny relativní pamì»ové pozice nejnutnìj¹ích argumentù a pøípadné
doplnìní kostry programu v assembleru èi GNU C (s èasovací smyèkou opìt
v assembleru), aby mohli souèasní u¾ivatelé snadno doplnit rutiny pro
svoje HC12 (èi vývojové desky) a rovnì¾ aby byl, narozdíl od souèasného
kódu, pøedán parametr taktovací frekvence.
</p>
<p>Co dìlat, poøebujete-li za souèasného stavu vìcí pou¾ívat FLASH u
svého modelu HC12? Byl jsem ve stejné situaci, kdy¾ jsem na zaèátku
léta potøeboval pøipravit pro kolegu z katedry podporu vnitøní FLASH
odrùdy M68HC12D60A, pro jednoduchost alespoò horní 32KB banky. Cestou
nejmen¹ího odporu (úprav gdb) aneb cestou nejvìt¹í, leè nejrychlej¹í
prasárny, pouze jsem nahradil kód HC12B32 v bdm12_*flash.h kódem pro
HC12D60A.
</p>
<p>Ze studijnì-zvìdavostních dùvodù jsem kód nepsal sám, ale pou¾il
jsem rutiny, sta¾itelné <a href="http://www.pemicro.com/support/flash_list_menu.cfm">ze serveru P&amp;E</a>. Cílem bylo zauva¾ovat
zároveò o tom, zda by v budoucí (snad se doèkáme) podpoøe dynamicky
nahrávaných modulù nebylo vhodné pou¾ít stejnou èi podobnou koncepci,
jako na¹i pøedchùdci.

Pokud vám to svìdomí a zákony va¹í zemì dovolí, zjistíte, ¾e jsou to vlastnì
o hlavièku s poèáteèním nastavením jakýchsi registrù obohacené S-recordy;
tu hlavièku je mo¾né umazat a výsledný soubor kru»ácky disassemblovat pomocí
<tt>m68hc12-objdump -mm68hc12 -D neco.sx</tt>. Potøebujete-li to rychle
a pro vlastní potøebu, snad se nikdo zlobit nebude.
</p>

<a name="4-1-5"></a><h3>Zaèlenìní programovací rutiny do souèasného (neutì¹eného) kódu
  v gdb</h3>

<p>Uvedu postup, kterým jsem, by» velmi prozatimnì (a jak víme,
provizoria jsou vìèná), vlo¾il do gdb kód na mazání a zapisování do
32KB FLASH HC12D60A. Patch gdb pro programování 32KB FLASH u D60A tímto
kódem je <a href="sw/flash/gdb-blesk_d60.diff">zde</a>.
</p>
<ul>
<li>vytvoøit vlastní program, nejspí¹ v assembleru, ale ani v C by to
nemìl být problém (snad sem dám èasem nìjaký pøíklad); programovací
algoritmus (do kterých registrù kdy co zapsat a kolik mikrosekund kde
èekat) je popsán v katalogovém listu pøíslu¹ného procesoru (pro D60A je
to <a href="doc/MC68HC912D60A.pdf">tady</a> na stranì 102),
nìkdy dokonce i v technické zpávì
(pro D60A je to <a href="doc/M68HC12_AN2166.pdf">tahle</a>)</li>
<li>jak mù¾e vypadat
výsledek, lze se podívat <a href="sw/flash/blesk_d60/blesk.s">sem</a>;
poznámka: z tì¾ké lenosti jsem neèlenil program na èást mazací a programovací,
nechal jsem to v jednom kuse, i kdy¾ mazací rutina zabírá v RAM zbyteènì místo
  </li>
<li>pøelo¾it program -- z nìjakého dùvodu se mi nedaøilo dosíci
výsledku, tj. binární podoby kódu, umístìného v RAM od adresy 0x800, s
GNU assemblerem gas a binutils -- pøi pøevodu pomocí objcopy mi to
dávalo místo adres nesmyslné nuly (holt s tìmi GNU nástroji neumím,
nezobte se); øe¹ení, by» trapné:
    <ul>
<li>pou¾il jsem assembler ASM12 firmy <a href="http://www.mgtek.com/">MGTEK</a>, sta¾itelný zdarma
v spustitelné podobì pro Linux a HP-UX <a href="http://www.mgtek.com/miniide/download/unix.aspx">zde</a>
</li>
<li>tento assembler bohu¾el ¾ere trochu jinou syntaxi ne¾ GAS,
tak jsem si napsal pøevelice smì¹ný pøevodní prográmek v perlu
<a href="sw/flash/blesk_d60/gas2mgtek.pl">gas2mgtek.pl</a>
</li>
</ul>
  </li>
<li>z programu potom udìlat konstantu (globální promìnnou) do
hlavièkového souboru <tt>bdm*flash.h</tt>, já jsem na to pou¾il
<a href="sw/flash/blesk_d60/mpconvert.c">mpconvert.c</a>
(viz pùvodní <tt>convert.c</tt> v komentáøi Tima Housela) a tohle
<a href="sw/flash/blesk_d60/Makefile">Makefile</a>;
vzniklý hlavièkový soubor je v mém "úsporném" pøípadì
<a href="sw/flash/blesk_d60/bdm12_programflash.h">vlo¾en</a>
do bdm12_program i eraseflash.h</li>
</ul>
<p>Ukázkové soubory jsou ke sta¾ení <a href="sw/flash/blesk_d60/">zde</a> (zabalené <a href="sw/flash/blesk_d60.tar.gz">zde</a>).
</p>


<a name="4-2"></a><h2>gcc a binutils pro HC11, HC12</h2>

<p>Tvorbou gdb, nástrojù binutils a kompilátorù C a asembleru gcc, gas
se zabývá <a href="http://m68hc11.serveftp.org/">gnu-m68hc1x</a>
(<a href="http://stephane.carrez.free.fr/m68hc11_port.php">jiný odkaz</a>). Na tìchto stránkách je mo¾né najít
rùzné návody a pouèky, jak kompilovat pro HC12, jak pou¾ívat ld a jeho
skripty, jak vyu¾ívat v gcc prostøedkù vlastních procesorùm HC12/HC11.
Rovnì¾ je udr¾ována dotazùm a návrhùm otevøená mailová konference
<a name="maillist"></a><a href="http://groups.yahoo.com/group/gnu-m68hc11/">gnu-mc68hc11@yahoogroups.com</a>.
</p>

<p></p>
<br><hr size="1">
<table border="0" width="100%"><tr>
<td align="left"><em>Podex -- rozhraní 68HC12 BDM</em></td>
<td align="center"><a href="http://duch.cz/podex/">http://duch.cz/podex/</a></td>
<td align="right">
<em>Marek Peca,</em> &lt;<a href="mailto:marek@duch.cz">marek@duch.cz</a>&gt;</td>
</tr></table>
</body>
</html>
