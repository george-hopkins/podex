<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-2">
<title>Podex -- rozhraní 68HC12 BDM -- Firmware (program unvitø podexu)</title>
</head>
<body>
<table border="0" width="100%"><tr>
<td valign="top" align="left"><ul>
<li><a href="index.html">Podex, 68HC12 BDM</a></li>
<li><a href="podex_hw.html">Hardware</a></li>
<li>
<i>Firmware (program unvitø podexu)</i><ul>
<li>
<a href="podex_fw.html#3-1">Popis protokolu (aplikaèní vrstva)</a><ul>
<li><a href="podex_fw.html#3-1-1">Pøíkazy BDM</a></li>
<li><a href="podex_fw.html#3-1-2">Pøehled pøíkazù podexu</a></li>
</ul>
</li>
<li>
<a href="podex_fw.html#3-2">Popis protokolu (fyzická vrstva)</a><ul>
<li><a href="podex_fw.html#3-2-1">Sériová linka</a></li>
<li><a href="podex_fw.html#3-2-2">Rozhraní BDM</a></li>
</ul>
</li>
<li><a href="podex_fw.html#3-3">Popis programu</a></li>
</ul>
</li>
<li><a href="podex_gdb.html">Software</a></li>
<li><a href="podex_eg.html">Pøíklad pou¾ití</a></li>
<li><a href="podex_faq.html">ÈKD</a></li>
</ul></td>
<td valign="bottom" align="right">
<h1>Firmware (program unvitø podexu)</h1>[ <a href="podex_fw.en.html">english</a> ]</td>
</tr></table>
<hr>
<a name="podex_fw"></a>

<p>Provoz mezi sériovou linkou (pøíkazy debuggeru -- øídicího poèítaèe)
a rozhraním BDM (pøíkazy BDM) pøevádí firmware v jednoèipu AVR.
Firmware zkompilovaný pro krystal podexu o frekvenci 9.216MHz a
sériovou linku o rychlosti 115200b/s je mo¾no ve formátu Intel-HEX
stáhnout <a name="podex-hex"></a><a href="fw/podex.hex">zde</a>.
</p>
<blockquote><table border="1" cellspacing="0" cellpadding="3"><tr><td><pre>
Zde snad nìkdy bude CGI assembler...
</pre></td></tr></table></blockquote>
<p>Mù¾ete si rovnì¾ stáhnout zdrojový kód firmwaru
<a href="fw/podex.s">podex.s</a>
(a definièní soubor <a href="fw/2313def.inc">2313def.inc</a>).
Pomocí GNU binutils pro AVR zkompilujete pøíkazy:</p>
<blockquote><table border="1" cellspacing="0" cellpadding="3"><tr><td><pre>
avr-as -o podex.o podex.s
avr-ld -o podex.out podex.o
avr-objcopy -R .eeprom -O ihex podex.out podex.hex
</pre></td></tr></table></blockquote>
<a name="3-1"></a><h2>Popis protokolu (aplikaèní vrstva)</h2>

<p>Protokol sériové linky mezi podexem a øídicím poèítaèem se sna¾í být
kompatibilní se zveøejnìným protokolem krabièky BDM12 Kevina Rosse ve
verzi 4.7 (dále jen K.R.BDM12). Protokol je (s výjimkou nadmíru
zpackaného pøíkazu TraceTo)
navr¾en tak, ¾e øídicí poèítaè vysílá podexu pøíkazy, z nich¾ nìkteré
jsou doplnìny argumenty (daty) a nìkteré mohu mít za následek, ¾e podex
ode¹le data v odpovìï øídicímu poèítaèi. Provoz je tedy v¾dy zahájen ze
strany øídicího poèítaèe a v¾dy je známo, jaké mno¾ství dat je mo¾no
oèekávat v odpovìï.
</p>
<p>Pøíkazy protokolu spadají do tøech skupin:
</p>
<ul>
<li>vlastní pøíkazy rozhraní BDM, které podex jen tlumoèí mezi
sériovou linkou a BDM; ty se dìlí na
    <ul>
<li>hardwarové pøíkazy BDM -- jsou v procesoru HC12 provedeny s
¾ádným nebo alespoò co nejmen¹ím èasovým naru¹ením právì vykonávaného
programu (nejsou toti¾ tvoøeny strojovým kódem procesoru)</li>
<li>firmwarové pøíkazy BDM -- jsou tvoøeny krátkými rutinami v
skryté ROM procesoru HC12 a pøed jejich provádìním musí být pozastaveno
vykonávání programu jádrem procesoru;
      </li>
</ul>
  </li>
<li>nutné øídicí povely k nastavení èasování BDM sbìrnice a k
ovládání linky RESET (pøípadnì linek MODA, MODB) -- toto jsou jediné
potøebné pøíkazy kromì tlumoèení BDM, které by byly potøeba pro
plnohodnotné pou¾ívání BDM rozhraní</li>
<li>zbyteèné pøíkazy -- pøíkazy, které jsou obsa¾eny v protokolu
Kevina Rosse a stávající programy nìkteré z nich pou¾ívají, ale je
mo¾né se bez nich obejít (je pravda, ¾e jejich pou¾ití mù¾e uspoøit
vytí¾ení sériové linky, pøesto jejich existenci pova¾uji za ne¹»astnou)</li>
</ul>
<a name="3-1-1"></a><h3>Pøíkazy BDM</h3>

<p>Hardwarové pøíkazy BDM mù¾e procesor HC12 provést v jakémkoli
okam¾iku, pøièem¾ obvody procesoru se je pokusí provést tak, aby
nedo¹lo k èasovému naru¹ení (prodlou¾ení) právì probíhající instrukce.
To se nemusí podaøit, pokud je k provedení pøíkazu BDM tøeba více cyklù
ne¾ jeden.
</p>
<p>Firmwarové pøíkazy BDM je mo¾né provádìt pouze, je-li jádro HC12
pozastaveno -- tento stav se nazývá "BDM aktivní" (ov¹em hardwarové
pøíkazy BDM je mo¾né vykonávat kdykoli, mimo tento stav i v nìm). Do
stavu s aktivním BDM se mù¾e HC12 dostat
</p>
<ul>
<li>ji¾ pøi resetu, je-li v okam¾iku nábì¾né hrany linka BKGD
(rozhraní BDM)
v úrovni logické 0</li>
<li>poté, co procesor vykoná instrukci strojového kódu BGND</li>
<li>provedením hardwarového pøíkazu BDM jménem BACKGROUND -- pøedtím
musí být tato operace povolena nastavením nejvy¹¹ího bitu (0x80) v
registru STATUS BDM
  </li>
</ul>
<p>V re¾imu aktivního BDM vykonává jádro HC12 místo u¾ivatelského
programu kód (firmware) ze zvlá¹tní pamìti ROM.
Re¾im aktivního BDM je opu¹tìn tehdy, je-li firmwarovým pøíkazem BDM
zahájeno vykonávání u¾ivatelského programu (pøíkazy GO, TAGGO...).
Registry BDM (jako napøíklad STATUS) a ROM BDM firmwaru jsou umístìny
mimo u¾ivatelský pamì»ový prostor a pouze pro úèely BDM jsou do nìj
mapovány na adresy 0xff00..0xffff.
</p>

<a name="3-1-2"></a><h3>Pøehled pøíkazù podexu</h3>

<p>Komunikace probíhá po slabikách (bajtech). První jedna nebo dvì
slabiky, vyslané poèítaèem, tvoøí pøíkaz, dále mohou následovat
argumenty nebo data (vstup) a nìjaká data pak mohou být pøijata
(výstup). Poèet slabik a pøípdnì endián (poøadí slabik ve slovu)
pøíslu¹ného data je v pøehledu uveden v závorce. Endián je znaèen m
(malý, tj. ménì významné slabiky jako první) a v (velký, tj.
významnìj¹í slabiky jako první). Napøíklad Poèet(2m) oznaèuje 16bitový
argument Poèet, kde nejprve je vysláno dolních 8 bitù a poté horních
8 bitù.
</p>
<a name="p-sync"></a>
<table border="1" cellspacing="0" cellpadding="3">
<tr>
<td>jméno:
      </td>
<td>Sync
      </td>
</tr>
<tr>
<td>skupina:
      </td>
<td>(zvlá¹tní)
      </td>
</tr>
<tr>
<td>pøíkaz:
      </td>
<td>0x00
      </td>
</tr>
<tr>
<td>vstup:
      </td>
<td>--
      </td>
</tr>
<tr>
<td>výstup:
      </td>
<td>--
      </td>
</tr>
</table>
<p>Pøíkaz Sync nedìlá nic, slou¾í jako ne¹kodná výplò, kterou je mo¾no
pou¾ít k ubití nedokonèených naèatých pøíkazù po výpadku komunikace.
Dokumentace K.R.BDM12 øíká, ¾e vyslání 6ti pøíkazù Sync vrátí krabièku
z chybového stavu do pøipraveného stavu (èekání na dal¹í pøíkaz) -- to
se ov¹em nemusí podaøit, pokud byl nìjakou chybou vyvolán pøíkaz
<a href="podex_fw.html#p-mem-put">MemPut</a>,
který mù¾e oèekávat mnoho vstupních dat.
</p>
<a name="reset"></a>
<table border="1" cellspacing="0" cellpadding="3">
<tr>
<td>jméno:
      </td>
<td>Reset
      </td>
</tr>
<tr>
<td>skupina:
      </td>
<td>øídicí
      </td>
</tr>
<tr>
<td>pøíkaz:
      </td>
<td>0x01
      </td>
</tr>
<tr>
<td>vstup:
      </td>
<td>--
      </td>
</tr>
<tr>
<td>výstup:
      </td>
<td>--
      </td>
</tr>
</table>
<p>Pøíkaz Reset dle dokumentace K.R.BDM12 shodí linky RESET i BKGD do
logické 0, poèká 10ms, vrátí RESET do logické 1, poèká stanovenou dobu
a nakonec vrátí BKGD do logické 1. Tím by mìlo dojít k resetu procesoru
do re¾imu s aktivním BDM. Doba èekání mezi nábì¾nýmí hranami RESET a
BKGD je nastavena celým èíslem v ms pøíkazem <a href="podex_fw.html#p-set-param">SetParam</a>.
</p>
<p>Oproti K.R.BDM12 èeká podex v¾dy nejménì 1ms (i kdy¾ je pøíkazem
<a href="podex_fw.html#p-set-param">SetParam</a> nastaveno 0ms),
nebo» nìkteré zkou¹ené procesory pøi tìsném
sledu nábì¾ných hran ¹patnì nabíhaly. Dále není ve skuteènosti u linek
nastavována pevná logická úroveò 1, ale pouze odpojený stav
(pøedpokládám, ¾e na desce je nìjaký obvod, který tahá RESET do log.1).
U linky BKGD je vyslán kra»ouèký zrychlovací puls log.1 pøed pøechodem
do odpojeného stavu. Dal¹í zmìnou je, ¾e pøed nábì¾nou hranou BKGD je
sledováno, zda se linka RESET skuteènì vrátila do log.1 -- nìkdy mù¾e
deska s HC12 obsahovat obvod, který podr¾í RESET v log.0 déle. Toto chování
doporuèuje <a href="index.html#zdenek-rozehnal">Zdenìk Rozehnal</a>.
</p>
<a name="p-reset-low"></a>
<table border="1" cellspacing="0" cellpadding="3">
<tr>
<td>jméno:
      </td>
<td>ResetLOW
      </td>
</tr>
<tr>
<td>skupina:
      </td>
<td>øídicí
      </td>
</tr>
<tr>
<td>pøíkaz:
      </td>
<td>0x02
      </td>
</tr>
<tr>
<td>vstup:
      </td>
<td>--
      </td>
</tr>
<tr>
<td>výstup:
      </td>
<td>--
      </td>
</tr>
</table>
<p>Shodí linku RESET do log.0.
</p>
<a name="p-reset-high"></a>
<table border="1" cellspacing="0" cellpadding="3">
<tr>
<td>jméno:
      </td>
<td>ResetHIGH
      </td>
</tr>
<tr>
<td>skupina:
      </td>
<td>øídicí
      </td>
</tr>
<tr>
<td>pøíkaz:
      </td>
<td>0x03
      </td>
</tr>
<tr>
<td>vstup:
      </td>
<td>--
      </td>
</tr>
<tr>
<td>výstup:
      </td>
<td>--
      </td>
</tr>
</table>
<p>Dle K.R.BDM12 nastaví RESET do log.1. Podex nastaví pouze odpojený
stav.
</p>
<a name="p-eeprom-write"></a>
<table border="1" cellspacing="0" cellpadding="3">
<tr>
<td>jméno:
      </td>
<td>EEPROMWrite
      </td>
</tr>
<tr>
<td>skupina:
      </td>
<td>zbyteèné
      </td>
</tr>
<tr>
<td>pøíkaz:
      </td>
<td>0x05
      </td>
</tr>
<tr>
<td>vstup:
      </td>
<td>Adresa(2v)
Slovo(2v)
      </td>
</tr>
<tr>
<td>výstup:
      </td>
<td>--
      </td>
</tr>
</table>
<p>Zapí¹e Slovo na Adresu do vnitøní pamìti EEPROM HC12, pøièem¾ se
nejprve
ujistí, zda je tøeba slovo na dané adrese mazat a pokud ne,
naprogramuje pouze pøidané bity. Pro pøístup k pamìti EEPROM musí
vìdìt, kde v pamìti se nacházejí (kam jsou namapovány) registry HC12 --
to je podexu sdìleno pøíkazem <a href="podex_fw.html#p-set-register-base">SetRegisterBase</a>.
</p>
<p>Pozor, nejsem si jist, zda v¹echny varianty HC12 pou¾ívají stejný
pøístup k pamìti EEPROM. Podex pou¾ívá registr EEPROG, který by mìl
fungovat v procesorech 68HC12B* a 68HC12D*.
</p>
<a name="p-set-register-base"></a>
<table border="1" cellspacing="0" cellpadding="3">
<tr>
<td>jméno:
      </td>
<td>SetRegisterBase
      </td>
</tr>
<tr>
<td>skupina:
      </td>
<td>zbyteèné
      </td>
</tr>
<tr>
<td>pøíkaz:
      </td>
<td>0x06
      </td>
</tr>
<tr>
<td>vstup:
      </td>
<td>RegBaseHi(1)
      </td>
</tr>
<tr>
<td>výstup:
      </td>
<td>--
      </td>
</tr>
</table>
<p>Dá vìdìt podexu, kde se nacházejí registry HC12, argumentem je
horních 8 bitù adresy, na ní¾ zaèínají (jsou namapovány) registry HC12.
Podex sám neprovede mapování registrù, to musí udìlat buï program v
øídicím poèítaèi nebo v HC12.
</p>
<a name="p-bulk-erase-eeprom"></a>
<table border="1" cellspacing="0" cellpadding="3">
<tr>
<td>jméno:
      </td>
<td>BulkEraseEEPROM
      </td>
</tr>
<tr>
<td>skupina:
      </td>
<td>zbyteèné
      </td>
</tr>
<tr>
<td>pøíkaz:
      </td>
<td>0x07
      </td>
</tr>
<tr>
<td>vstup:
      </td>
<td>Adresa(2v)
      </td>
</tr>
<tr>
<td>výstup:
      </td>
<td>--
      </td>
</tr>
</table>
<p>Sma¾e celou vnitøní EEPROM HC12. Argumentem je adresa, nacházející
se nìkde v prostoru, kam je namapována EEPROM. Jinak viz <a href="podex_fw.html#p-eeprom-write">EEPROMWrite</a>.
</p>
<a name="p-get-version"></a>
<table border="1" cellspacing="0" cellpadding="3">
<tr>
<td>jméno:
      </td>
<td>GetVersion
      </td>
</tr>
<tr>
<td>skupina:
      </td>
<td>(zvlá¹tní)
      </td>
</tr>
<tr>
<td>pøíkaz:
      </td>
<td>0x04 0x00
      </td>
</tr>
<tr>
<td>vstup:
      </td>
<td>--
      </td>
</tr>
<tr>
<td>výstup:
      </td>
<td>0x47 [Verze(1)]
      </td>
</tr>
</table>
<p>Dle K.R.BDM12 má tento pøíkaz vrátit verzi firmwaru a informovat o
tom, zda jsou pøítomny linky MODA, MODB. Pozor, nìkteré ni¾¹í verze
K.R.BDM12 jsou navzájem nekompatibilní jak na aplikaèní vrstvì, tak na
<a href="podex_fw.html#fyzicka-rts-cts">fyzické</a>
(pou¾ití RTS, CTS rozhraní RS232). Podex vrací konstantnì 0xc7,
tj. verzi 4.7 s linkami MODA, MODB. </p>
<a name="p-reg-dump"></a>
<table border="1" cellspacing="0" cellpadding="3">
<tr>
<td>jméno:
      </td>
<td>RegDump
      </td>
</tr>
<tr>
<td>skupina:
      </td>
<td>zbyteèné
      </td>
</tr>
<tr>
<td>pøíkaz:
      </td>
<td>0x04 0x01
      </td>
</tr>
<tr>
<td>vstup:
      </td>
<td>--
      </td>
</tr>
<tr>
<td>výstup:
      </td>
<td>0x83 [Pøíznak(1)]
StatusBDM(1)
PC(2v)
D(2v)
X(2v)
Y(2v)
SP(2v)
CCR(1)
      </td>
</tr>
</table>
<p>Pøíkaz vrátí obsah registru STATUS BDM a registrù jádra HC12. Z
dokumentace to není zcela jednoznaèné, ale zøejmì má být výpis uvozen
Pøíznakem, informujícím, ¾e bude vrácen STATUS BDM (0x01) a výpis
registrù (0x02) a ¾e nebude nic následovat (0x80).
</p>
<a name="p-trace-to"></a>
<table border="1" cellspacing="0" cellpadding="3">
<tr>
<td>jméno:
      </td>
<td>TraceTo
      </td>
</tr>
<tr>
<td>skupina:
      </td>
<td>zbyteèné
      </td>
</tr>
<tr>
<td>pøíkaz:
      </td>
<td>0x04 0x02
      </td>
</tr>
<tr>
<td>vstup:
      </td>
<td>Re¾im(1)
Adresa(2v?) nebo Poèet(2v??)
      </td>
</tr>
<tr>
<td>výstup:
      </td>
<td>...
      </td>
</tr>
</table>
<blockquote><table border="1" cellspacing="0" cellpadding="3"><tr><td><pre>
tenhle o¹klivej pøíkaz se popisuje dost ¹patnì...
</pre></td></tr></table></blockquote>
<a name="p-mem-dump"></a>
<table border="1" cellspacing="0" cellpadding="3">
<tr>
<td>jméno:
      </td>
<td>MemDump
      </td>
</tr>
<tr>
<td>skupina:
      </td>
<td>zbyteèné
      </td>
</tr>
<tr>
<td>pøíkaz:
      </td>
<td>0x04 0x03
      </td>
</tr>
<tr>
<td>vstup:
      </td>
<td>Adresa(2v)
N(2v)
      </td>
</tr>
<tr>
<td>výstup:
      </td>
<td>N-krát Slovo(2v)
      </td>
</tr>
</table>
<p>Vypí¹e N slov z pamìti HC12 Adresou poèínaje (vèetnì). Adresa musí
být
sudá, N nenulové. (Z dokumentace
K.R.BDM12 není jasné, jakého endiánu mají být argumenty a naètená
data -- zji¹tìno z kódu GNU gdb.)
</p>
<a name="p-set-param"></a>
<table border="1" cellspacing="0" cellpadding="3">
<tr>
<td>jméno:
      </td>
<td>SetParam
      </td>
</tr>
<tr>
<td>skupina:
      </td>
<td>øídicí
      </td>
</tr>
<tr>
<td>pøíkaz:
      </td>
<td>0x04 0x04
      </td>
</tr>
<tr>
<td>vstup:
      </td>
<td>ECLOCK(1)
PaceCount(1)
ResetCount(1)
      </td>
</tr>
<tr>
<td>výstup:
      </td>
<td>--
      </td>
</tr>
</table>
<p>Tento pøíkaz nastavuje èasování podexu. Argument ECLOCK urèuje
frekvenci sbìrnice BDM (0x00 ~ 1MHz, 0x01 ~ 2MHz, 0x02 ~ 4MHz, 0x03 ~
8MHz, 0x04 ~ jiná frekvence, nastavovaná pøíkazem ExtendedSpeed). Zbylé
argumenty udávají èasovou prodlevu v ms, PaceCount prodlevu mezi kroky
pøíkazu <a href="podex_fw.html#p-trace-to">TraceTo</a> a ResetCount prodlevu
mezi nábì¾nými hranami pøíkazu <a href="">Reset</a>.
</p>
<a name="p-ioctl"></a>
<table border="1" cellspacing="0" cellpadding="3">
<tr>
<td>jméno:
      </td>
<td>IOCTL
      </td>
</tr>
<tr>
<td>skupina:
      </td>
<td>øídicí
      </td>
</tr>
<tr>
<td>pøíkaz:
      </td>
<td>0x04 0x05
      </td>
</tr>
<tr>
<td>vstup:
      </td>
<td>LineControl(1)
      </td>
</tr>
<tr>
<td>výstup:
      </td>
<td>--
      </td>
</tr>
</table>
<p>Pøíkazem IOCTL jsou pøímo ovládány výstupní linky podexu -- BKGD,
RESET, MODA, MODB a svítivé diody. V pùvodním K.R.BDM12 jsou na
roz¹íøený konektor BDM je¹tì vyvedeny signály pro budoucí pou¾ití,
zvané RSRV1 a RSRV2 -- ty v pøedkládaném zapojení nejsou obsazeny, ale
v pøípadì potøeby je mo¾né je zapojit na vývody PB4, PB5 jednoèipu AVR
(ani¾ by bylo tøeba mìnit firmware). Argument LineControl nastavuje
zmínìné linky do logických úrovní podle obsahu jednotlivých bitù
argumentu:
</p>
<table border="1" cellspacing="0" cellpadding="3">
<tr>
<td>0
      </td>
<td>1
      </td>
<td>2
      </td>
<td>3
      </td>
<td>4
      </td>
<td>5
      </td>
<td>6
      </td>
<td>7
      </td>
</tr>
<tr>
<td>BKGD
      </td>
<td>RESET
      </td>
<td>èervená LED
      </td>
<td>zelená LED
      </td>
<td>RSRV1
      </td>
<td>RSRV2
      </td>
<td>MODB
      </td>
<td>MODA
      </td>
</tr>
</table>
<p>Specifikace K.R.BDM12 bohu¾el nedovoluje nastavení výstupních linek
do odpojeného stavu, co¾ je dosti ne¹ikovné. Prozatím jsem ve firmware
podexu nechal pøíkaz IOCTL nastavovat v¹echny linky natvrdo do
výstupního re¾imu, pøièem¾ linku RESET je mo¾né do odpojeného stavu
vrátit pøíkazem <a href="podex_fw.html#p-reset-high">ResetHIGH</a>,
linka BKGD se do nìj pak vrací po ukonèení
pøíkazù BDM.
</p>
<a name="p-mem-put"></a>
<table border="1" cellspacing="0" cellpadding="3">
<tr>
<td>jméno:
      </td>
<td>MemPut
      </td>
</tr>
<tr>
<td>skupina:
      </td>
<td>zbyteèné
      </td>
</tr>
<tr>
<td>pøíkaz:
      </td>
<td>0x04 0x06
      </td>
</tr>
<tr>
<td>vstup:
      </td>
<td>Adresa(2v)
N(2v)
N-krát Slovo(2v)
      </td>
</tr>
<tr>
<td>výstup:
      </td>
<td>--
      </td>
</tr>
</table>
<p>Zapí¹e do pamìti HC12 N slov poèínaje Adresou (vèetnì). Adresa musí
být sudá, N nenulové. Endián viz <a href="podex_fw.html#p-mem-dump">MemDump</a>.
</p>
<a name="p-extended-speed"></a>
<table border="1" cellspacing="0" cellpadding="3">
<tr>
<td>jméno:
      </td>
<td>ExtendedSpeed
      </td>
</tr>
<tr>
<td>skupina:
      </td>
<td>øídicí
      </td>
</tr>
<tr>
<td>pøíkaz:
      </td>
<td>0x04 0x07
      </td>
</tr>
<tr>
<td>vstup:
      </td>
<td>EClockScalar(1)
128EClocks(2?)
      </td>
</tr>
<tr>
<td>výstup:
      </td>
<td>--
      </td>
</tr>
</table>
<p>Pøíkazem ExtendedSpeed je mo¾no jemnì nastavit frekvenci BDM
sbìrnice. Hodnoty argumentù vycházejí z konkrétního firmwaru v
jednoèipu PIC16C715 na 20MHz pùvodního K.R.BDM12. Vztah pro výpoèet
hodnoty EClockScalar v dokumentaci K.R.BDM12 chybí, co¾ ov¹em moc
nevadí, nebo» tá¾ informace je obsa¾ena i v druhém 16bitovém argumentu
-- podex hodnotu EClockScalar ingoruje a èasování odvozuje z argumentu
128EClocks. Tato hodnota je vypoètena ze vztahu
</p>
128EClocks = (128e9/f - 1400)/800 = 160e6/f - 1.75
<p>kde f je frekvence BDM sbìrnice v Hz. Dokumentace K.R.BDM12
doporuèuje zaokrouhlení hodnoty 128EClocks nahoru. Endián argumentu
128EClocks zatím neznám -- není zdokumentován.
</p>
<a name="p-background"></a>
<table border="1" cellspacing="0" cellpadding="3">
<tr>
<td>jméno:
      </td>
<td>BACKGROUND
      </td>
</tr>
<tr>
<td>skupina:
      </td>
<td>hardwarové BDM
      </td>
</tr>
<tr>
<td>pøíkaz:
      </td>
<td>0x90
      </td>
</tr>
<tr>
<td>vstup:
      </td>
<td> --
      </td>
</tr>
<tr>
<td>výstup:
      </td>
<td> --
      </td>
</tr>
</table>
<p>Zpùsobí pøechod HC12 do re¾imu aktivního BDM -- pozastaví vykonávání
u¾ivatelského programu a umo¾ní provádìní firmwarových pøíkazù BDM. Pro
úspì¹né provedení tohoto pøíkazu je nejprve tøeba nastavit nejvy¹¹í bit
v registru STATUS BDM.
</p>
<a name="p-write-byte"></a>
<table border="1" cellspacing="0" cellpadding="3">
<tr>
<td>jméno:
      </td>
<td>WRITE_BYTE
      </td>
</tr>
<tr>
<td>skupina:
      </td>
<td>hardwarové BDM
      </td>
</tr>
<tr>
<td>pøíkaz:
      </td>
<td>0xc0
      </td>
</tr>
<tr>
<td>vstup:
      </td>
<td> Adresa(2v)
SudáSlabika(1)
LicháSlabika(1)
      </td>
</tr>
<tr>
<td>výstup:
      </td>
<td> --
      </td>
</tr>
</table>
<p>Zapí¹e slabiku do u¾ivateli pøístupné pamìti na Adresu, je-li Adresa
sudá, pou¾ije se SudáSlabika, jinak LicháSlabika (opaèná je ignorována).
</p>
<a name="p-write-bd-byte"></a>
<table border="1" cellspacing="0" cellpadding="3">
<tr>
<td>jméno:
      </td>
<td>WRITE_BD_BYTE
      </td>
</tr>
<tr>
<td>skupina:
      </td>
<td>hardwarové BDM
      </td>
</tr>
<tr>
<td>pøíkaz:
      </td>
<td>0xc4
      </td>
</tr>
<tr>
<td>vstup:
      </td>
<td> Adresa(2v)
SudáSlabika(1)
LicháSlabika(1)
      </td>
</tr>
<tr>
<td>výstup:
      </td>
<td> --
      </td>
</tr>
</table>
<p>Zapí¹e slabiku do u¾ivateli skryté pamìti BDM na danou Adresu (pamì»
BDM je mapována od adresy 0xff00). Je-li Adresa sudá, pou¾ije se
SudáSlabika, jinak LicháSlabika (opaèná je ignorována).</p>
<a name="p-write-word"></a>
<table border="1" cellspacing="0" cellpadding="3">
<tr>
<td>jméno:
      </td>
<td>WRITE_WORD
      </td>
</tr>
<tr>
<td>skupina:
      </td>
<td>hardwarové BDM
      </td>
</tr>
<tr>
<td>pøíkaz:
      </td>
<td>0xc8
      </td>
</tr>
<tr>
<td>vstup:
      </td>
<td> Adresa(2v)
Slovo(2v)
      </td>
</tr>
<tr>
<td>výstup:
      </td>
<td> --
      </td>
</tr>
</table>
<p>Zapí¹e Slovo do u¾ivateli pøístupné pamìti na Adresu. Adresa musí
být sudá.
</p>
<a name="p-write-bd-word"></a>
<table border="1" cellspacing="0" cellpadding="3">
<tr>
<td>jméno:
      </td>
<td>WRITE_BD_WORD
      </td>
</tr>
<tr>
<td>skupina:
      </td>
<td>hardwarové BDM
      </td>
</tr>
<tr>
<td>pøíkaz:
      </td>
<td>0xcc
      </td>
</tr>
<tr>
<td>vstup:
      </td>
<td> Adresa(2v)
Slovo(2v)
      </td>
</tr>
<tr>
<td>výstup:
      </td>
<td> --
      </td>
</tr>
</table>
<p>Zapí¹e Slovo do u¾ivateli skryté pamìti BDM na danou Adresu. Adresa
musí být sudá.
</p>
<a name="p-read-byte"></a>
<table border="1" cellspacing="0" cellpadding="3">
<tr>
<td>jméno:
      </td>
<td>READ_BYTE
      </td>
</tr>
<tr>
<td>skupina:
      </td>
<td>hardwarové BDM
      </td>
</tr>
<tr>
<td>pøíkaz:
      </td>
<td>0xe0
      </td>
</tr>
<tr>
<td>vstup:
      </td>
<td> Adresa(2v)
      </td>
</tr>
<tr>
<td>výstup:
      </td>
<td> SudáSlabika(1)
LicháSlabika(1)
      </td>
</tr>
</table>
<p>Ète slabiku z Adresy v u¾ivateli pøístupné pamìti. Je-li Adresa
sudá, je výsledek vrácen v SudéSlabice, jinak v LichéSlabice.
</p>
<a name="p-read-bd-byte"></a>
<table border="1" cellspacing="0" cellpadding="3">
<tr>
<td>jméno:
      </td>
<td>READ_BD_BYTE
      </td>
</tr>
<tr>
<td>skupina:
      </td>
<td>hardwarové BDM
      </td>
</tr>
<tr>
<td>pøíkaz:
      </td>
<td>0xe4
      </td>
</tr>
<tr>
<td>vstup:
      </td>
<td> Adresa(2v)
      </td>
</tr>
<tr>
<td>výstup:
      </td>
<td> SudáSlabika(1)
LicháSlabika(1)
      </td>
</tr>
</table>
<p>Ète slabiku z Adresy v u¾ivateli skryté pamìti BDM. Je-li Adresa
sudá, je výsledek vrácen v SudéSlabice, jinak v LichéSlabice. </p>
<a name="p-read-word"></a>
<table border="1" cellspacing="0" cellpadding="3">
<tr>
<td>jméno:
      </td>
<td>READ_WORD
      </td>
</tr>
<tr>
<td>skupina:
      </td>
<td>hardwarové BDM
      </td>
</tr>
<tr>
<td>pøíkaz:
      </td>
<td>0xe8
      </td>
</tr>
<tr>
<td>vstup:
      </td>
<td> Adresa(2v)
      </td>
</tr>
<tr>
<td>výstup:
      </td>
<td> Slovo(2v)
      </td>
</tr>
</table>
<p>Ète Slovo z Adresy v u¾ivateli pøístupné pamìti. Adresa musí být
sudá.
</p>
<a name="p-read-bd-word"></a>
<table border="1" cellspacing="0" cellpadding="3">
<tr>
<td>jméno:
      </td>
<td>READ_BD_WORD
      </td>
</tr>
<tr>
<td>skupina:
      </td>
<td>hardwarové BDM
      </td>
</tr>
<tr>
<td>pøíkaz:
      </td>
<td>0xec
      </td>
</tr>
<tr>
<td>vstup:
      </td>
<td> Adresa(2v)
      </td>
</tr>
<tr>
<td>výstup:
      </td>
<td> Slovo(2v)
      </td>
</tr>
</table>
<p>Ète Slovo z Adresy v u¾ivateli skryté pamìti BDM. Adresa musí být
sudá.
</p>
<a name="p-go"></a>
<table border="1" cellspacing="0" cellpadding="3">
<tr>
<td>jméno:
      </td>
<td>GO
      </td>
</tr>
<tr>
<td>skupina:
      </td>
<td>firmwarové BDM
      </td>
</tr>
<tr>
<td>pøíkaz:
      </td>
<td>0x08
      </td>
</tr>
<tr>
<td>vstup:
      </td>
<td> --
      </td>
</tr>
<tr>
<td>výstup:
      </td>
<td> --
      </td>
</tr>
</table>
<p>Ukonèí re¾im aktivního BDM a zahájí vykonávání u¾ivatelského
programu.
</p>
<a name="p-trace1"></a>
<table border="1" cellspacing="0" cellpadding="3">
<tr>
<td>jméno:
      </td>
<td>TRACE1
      </td>
</tr>
<tr>
<td>skupina:
      </td>
<td>firmwarové BDM
      </td>
</tr>
<tr>
<td>pøíkaz:
      </td>
<td>0x10
      </td>
</tr>
<tr>
<td>vstup:
      </td>
<td> --
      </td>
</tr>
<tr>
<td>výstup:
      </td>
<td> --
      </td>
</tr>
</table>
<p>Vykoná jednu instrukci u¾ivatelského programu a poté se vrátí zpìt
do re¾imu aktivního BDM.
</p>
<a name="p-taggo"></a>
<table border="1" cellspacing="0" cellpadding="3">
<tr>
<td>jméno:
      </td>
<td>TAGGO
      </td>
</tr>
<tr>
<td>skupina:
      </td>
<td>firmwarové BDM
      </td>
</tr>
<tr>
<td>pøíkaz:
      </td>
<td>0x18
      </td>
</tr>
<tr>
<td>vstup:
      </td>
<td> --
      </td>
</tr>
<tr>
<td>výstup:
      </td>
<td> --
      </td>
</tr>
</table>
<p>Zapne znaèkování (tagging) instrukcí a zahájí vykonávání
u¾ivatelského programu (znaèkování instrukcí nerozumím).
</p>
<a name="p-write-next"></a>
<table border="1" cellspacing="0" cellpadding="3">
<tr>
<td>jméno:
      </td>
<td>WRITE_NEXT
      </td>
</tr>
<tr>
<td>skupina:
      </td>
<td>firmwarové BDM
      </td>
</tr>
<tr>
<td>pøíkaz:
      </td>
<td>0x42
      </td>
</tr>
<tr>
<td>vstup:
      </td>
<td> Slovo(2v)
      </td>
</tr>
<tr>
<td>výstup:
      </td>
<td> --
      </td>
</tr>
</table>
<p>Zvìt¹í registr X o dvojku, poté zapí¹e na adresu z registru X dané
Slovo.
</p>
<a name="p-write-pc"></a>
<table border="1" cellspacing="0" cellpadding="3">
<tr>
<td>jméno:
      </td>
<td>WRITE_PC
      </td>
</tr>
<tr>
<td>skupina:
      </td>
<td>firmwarové BDM
      </td>
</tr>
<tr>
<td>pøíkaz:
      </td>
<td>0x43
      </td>
</tr>
<tr>
<td>vstup:
      </td>
<td> Slovo(2v)
      </td>
</tr>
<tr>
<td>výstup:
      </td>
<td> --
      </td>
</tr>
</table>
<p>Zapí¹e Slovo do registru PC.
</p>
<a name="p-write-d"></a>
<table border="1" cellspacing="0" cellpadding="3">
<tr>
<td>jméno:
      </td>
<td>WRITE_D
      </td>
</tr>
<tr>
<td>skupina:
      </td>
<td>firmwarové BDM
      </td>
</tr>
<tr>
<td>pøíkaz:
      </td>
<td>0x44
      </td>
</tr>
<tr>
<td>vstup:
      </td>
<td> Slovo(2v)
      </td>
</tr>
<tr>
<td>výstup:
      </td>
<td> --
      </td>
</tr>
</table>
<p>Zapí¹e Slovo do registru D.
</p>
<a name="p-write-x"></a>
<table border="1" cellspacing="0" cellpadding="3">
<tr>
<td>jméno:
      </td>
<td>WRITE_X
      </td>
</tr>
<tr>
<td>skupina:
      </td>
<td>firmwarové BDM
      </td>
</tr>
<tr>
<td>pøíkaz:
      </td>
<td>0x45
      </td>
</tr>
<tr>
<td>vstup:
      </td>
<td> Slovo(2v)
      </td>
</tr>
<tr>
<td>výstup:
      </td>
<td> --
      </td>
</tr>
</table>
<p>Zapí¹e Slovo do registru X.
</p>
<a name="p-write-y"></a>
<table border="1" cellspacing="0" cellpadding="3">
<tr>
<td>jméno:
      </td>
<td>WRITE_Y
      </td>
</tr>
<tr>
<td>skupina:
      </td>
<td>firmwarové BDM
      </td>
</tr>
<tr>
<td>pøíkaz:
      </td>
<td>0x46
      </td>
</tr>
<tr>
<td>vstup:
      </td>
<td> Slovo(2v)
      </td>
</tr>
<tr>
<td>výstup:
      </td>
<td> --
      </td>
</tr>
</table>
<p>Zapí¹e Slovo do registru Y.
</p>
<a name="p-write-sp"></a>
<table border="1" cellspacing="0" cellpadding="3">
<tr>
<td>jméno:
      </td>
<td>WRITE_SP
      </td>
</tr>
<tr>
<td>skupina:
      </td>
<td>firmwarové BDM
      </td>
</tr>
<tr>
<td>pøíkaz:
      </td>
<td>0x47
      </td>
</tr>
<tr>
<td>vstup:
      </td>
<td> Slovo(2v)
      </td>
</tr>
<tr>
<td>výstup:
      </td>
<td> --
      </td>
</tr>
</table>
<p>Zapí¹e Slovo do registru SP.
</p>
<a name="p-read-next"></a>
<table border="1" cellspacing="0" cellpadding="3">
<tr>
<td>jméno:
      </td>
<td>READ_NEXT
      </td>
</tr>
<tr>
<td>skupina:
      </td>
<td>firmwarové BDM
      </td>
</tr>
<tr>
<td>pøíkaz:
      </td>
<td>0x62
      </td>
</tr>
<tr>
<td>vstup:
      </td>
<td> --
      </td>
</tr>
<tr>
<td>výstup:
      </td>
<td> Slovo(2v)
      </td>
</tr>
</table>
<p>Zvìt¹í registr X o dvojku, poté pøeète z adresy z registru X vracené
Slovo.
</p>
<a name="p-read-pc"></a>
<table border="1" cellspacing="0" cellpadding="3">
<tr>
<td>jméno:
      </td>
<td>READ_PC
      </td>
</tr>
<tr>
<td>skupina:
      </td>
<td>firmwarové BDM
      </td>
</tr>
<tr>
<td>pøíkaz:
      </td>
<td>0x63
      </td>
</tr>
<tr>
<td>vstup:
      </td>
<td> --
      </td>
</tr>
<tr>
<td>výstup:
      </td>
<td> Slovo(2v)
      </td>
</tr>
</table>
<p>Vrátí obsah registru PC.
</p>
<a name="p-read-d"></a>
<table border="1" cellspacing="0" cellpadding="3">
<tr>
<td>jméno:
      </td>
<td>READ_D
      </td>
</tr>
<tr>
<td>skupina:
      </td>
<td>firmwarové BDM
      </td>
</tr>
<tr>
<td>pøíkaz:
      </td>
<td>0x64
      </td>
</tr>
<tr>
<td>vstup:
      </td>
<td> --
      </td>
</tr>
<tr>
<td>výstup:
      </td>
<td> Slovo(2v)
      </td>
</tr>
</table>
<p>Vrátí obsah registru D.
</p>
<a name="p-read-x"></a>
<table border="1" cellspacing="0" cellpadding="3">
<tr>
<td>jméno:
      </td>
<td>READ_X
      </td>
</tr>
<tr>
<td>skupina:
      </td>
<td>firmwarové BDM
      </td>
</tr>
<tr>
<td>pøíkaz:
      </td>
<td>0x65
      </td>
</tr>
<tr>
<td>vstup:
      </td>
<td> --
      </td>
</tr>
<tr>
<td>výstup:
      </td>
<td> Slovo(2v)
      </td>
</tr>
</table>
<p>Vrátí obsah registru X.
</p>
<a name="p-read-y"></a>
<table border="1" cellspacing="0" cellpadding="3">
<tr>
<td>jméno:
      </td>
<td>READ_Y
      </td>
</tr>
<tr>
<td>skupina:
      </td>
<td>firmwarové BDM
      </td>
</tr>
<tr>
<td>pøíkaz:
      </td>
<td>0x66
      </td>
</tr>
<tr>
<td>vstup:
      </td>
<td> --
      </td>
</tr>
<tr>
<td>výstup:
      </td>
<td> Slovo(2v)
      </td>
</tr>
</table>
<p>Vrátí obsah registru Y.
</p>
<a name="p-read-sp"></a>
<table border="1" cellspacing="0" cellpadding="3">
<tr>
<td>jméno:
      </td>
<td>READ_SP
      </td>
</tr>
<tr>
<td>skupina:
      </td>
<td>firmwarové BDM
      </td>
</tr>
<tr>
<td>pøíkaz:
      </td>
<td>0x67
      </td>
</tr>
<tr>
<td>vstup:
      </td>
<td> --
      </td>
</tr>
<tr>
<td>výstup:
      </td>
<td> Slovo(2v)
      </td>
</tr>
</table>
<p>Vrátí obsah registru SP.
</p>
<p>Pro podrobnìj¹í popis pøíkazù BDM doporuèuji nahlédnout do
dokumentace procesorù Motorola øad HC12 a HCS12. Èasování BDM vèetnì
nezbytných prodlev na provedení pøíkazù BDM je zaji¹tìno firmwarem
podexu.
</p>


<a name="3-2"></a><h2>Popis protokolu (fyzická vrstva)</h2>

<a name="3-2-1"></a><h3>Sériová linka</h3>

<a name="fyzicka-rts-cts"></a>
<p>Podex komunikuje s øídicím poèítaèem dle K.R.BDM12 verze 4.7, tj. po
sériovém rozhraní typu RS232 s pou¾itím signálù RTS a CTS. Rychlost
sériového pøenosu je pevnì nastavena (v prototypu 115200b/s), pou¾ívá
se 1 stopbit, 8 datových bitù a ¾ádná parita. Pøíjem slabik z podexu do
øídicího poèítèe probíhá bez úèasti linek RTS, CTS, kde¾to vysílání
slabik z poèítaèe do podexu je oboustrannì potvrzováno. Tím je
zabezpeèena pøipravenost podexu k vykonání pøíkazu. V dal¹ím bude linka
CTS øídicího poèítaèe, která je linkou RTS podexu, oznaèována jako
RTS_pod, linka RTS øídicího poèítèe, která je linkou CTS podexu, jako
CTS_pod.
</p>
<p>V klidovém stavu (1), kdy podex èeká na zahájení pøíjmu slabiky, je
RTS_pod i CTS_pod v log.0. Kdy¾ øídicí poèítaè nastaví CTS_pod do
log.1, pøejde podex do stavu èekání na pøíjem slabiky (2) a nastaví
RTS_pod do log.1. Pokud øídicí poèítaè místo vyslání slabiky vrátí
CTS_pod do log.0, vrací se podex do poèáteèního stavu (1). Jinak po
pøijetí slabiky podexem ze sériové linky pøejde podex do stavu (3), co¾
potvrdí shozením RTS_pod do log.0. V tomto stavu setrvá, dokud øídicí
poèítaè neshodí i CTS_pod do log.0. Potom mù¾e následovat pøíjem dal¹í
slabiky, nebo libovolnì dlouhé provádìní pøíkazu (vèetnì pøípadného
pøíjmu dat z podexu do øídicího poèítaèe).
</p>
<blockquote><table border="1" cellspacing="0" cellpadding="3"><tr><td><pre>
tady by mìl být hezký obrázek stavù...
</pre></td></tr></table></blockquote>
<p>Malou výjimkou je pøíkaz TraceTo, který mù¾e být pøeru¹en bìhem
svého provádìní tím, ¾e øídicí poèítaè nastaví CTS_pod do log.1.
</p>
<p>Nìkomu mo¾ná pøipadá zvlá¹tní pou¾ít tak slo¾itý potvrzovací postup.
V star¹ích verzích K.R.BDM12 byla skuteènì pou¾ita pouze linka RTS_pod,
aby bylo zabezpeèeno, ¾e øídicí poèítaè nebude vysílat pøíkazy, dokud
krabièka pracuje. Kevin Ross ale pí¹e, ¾e s tímto jednoduchým
potvrzováním byly problémy na nìkterých nových poèítaèích PC. Vìøím
tomu, nebo» i od jiných vývojáøù jsem sly¹el stí¾nosti na ubohou
funkènost sériových portù novìj¹ích PC. V pøípadì potøeby není problém
upravit proceduru pøíjmu slabiky podexem, aby pou¾ívala jiný druh
potvrzování.
</p>

<a name="3-2-2"></a><h3>Rozhraní BDM</h3>

<p>BDM HC12 je jednovodièové obousmìrné tøístavové rozhraní s èasováním
vázaným na pevnou frekvenci (frekvenci BDM sbìrnice, u øady HC12
odpovída frekvenci EClock, tj. polovinì frekvence krystalu procesoru).
V dal¹ím budu oznaèovat èasovou jednotku odpovídající jedné periodì
EClock jako 1E. V klidovém stavu je linka BKGD sbìrnice v úrovni
kldného napìtí (log.1), deska s HC12 by mìla obsahovat rezistor
(4..10kOhm) tahající nahoru.
</p>
<p>Pøenos jednoho bitu v¾dy zahajuje protìj¹ek HC12 -- øídicí poèítaè
(host) tím, ¾e stáhne linku do log.0 po jmenovitou dobu 4E (nejménì
2E). Èasování pøenosu jednoho bitu se odvozuje od okam¾iku zji¹tìní
sestupné hrany procesorem HC12 -- to se stane v dobì od 0 do 1E od
okam¾iku sestupné hrany.
</p>
<p>Pokud je bit pøená¹en smìrem do HC12, podr¾í øídicí poèítaè linku v
log.0, má-li být vyslán nulový bit, jinak nastaví (natvrdo) log.1,
má-li být vyslán jednièkoý bit. HC12 ète logickou úroveò linky v
okam¾iku 10E od zji¹tìní sestupné hrany. Pokud byl vysílán nulový bit,
øídicí poèítaè v okam¾iku 13E od sestupné hrany vrátí linku do
klidového stavu log.1. Od okam¾iku 16E od sestupné hrany dále je mo¾né
pøená¹et dal¹í bity.</p>
<blockquote><table border="1" cellspacing="0" cellpadding="3"><tr><td><pre>
tady by mìl být obrázek prùbìhu signálù pøi vysílání bitu do HC12...
</pre></td></tr></table></blockquote>
<p>Pokud je bit pøená¹en smìrem z HC12, odpojí øídicí poèítaè po
ukonèení zahajovacího log.0 pulsu výstup od sbìrnice a nastavení bitu
je ponecháno na HC12. Ta buï podr¾í linku v log.0, má-li být vyslán
nulový bit, nebo v okam¾iku 7E od zji¹tìní sestupné hrany vy¹le krátký,
tzv. zrychlovací puls, který uspí¹í návrat úrovnì linky do log.1 (v
odpojeném stavu se nabíjí vedení pøes tahací odpor a doba tohoto
procesu není zanedbatelná). Øídicí poèítaè by mìl pøeèíst logickou
úroveò linky v èase 10E od sestupné hrany. Pokud HC12 vysílala nulový
bit, v okam¾iku 13E od zji¹tìní sestupné hrany vrátí sbìrnici do
klidového stavu log.1. Od okam¾iku 16E od sestupné hrany dále je mo¾né
pøená¹et dal¹í bity.
</p>
<blockquote><table border="1" cellspacing="0" cellpadding="3"><tr><td><pre>
tady by mìl být obrázek prùbìhu signálù pøi pøíjmu bitu z HC12...
</pre></td></tr></table></blockquote>
<p>Firmware podexu se sna¾í èasovat vysílání bitu do HC12 posloupností:
log.0, prodleva 4E, úroveò dle bitu, prodleva 9E, log.1, prodleva 3E;
pøíjem bitu z HC12 posloupností: log.0, prodleva 4E, odpojeno, prodleva
6E, ètení úrovnì, prodleva 6E. Prodlevy jsou relizovány co nejkrat¹ími
smyèkami, které mají dobu trvání obecnì (3*N+M)T, kde 1T je perioda
frekvence jednoèipu AVR, N je èasovací konstanta, poèítaná podexem z
øídicím poèítaèem sdìlené frekvence BDM. Smyèky jsou stavìny tak, ¾e
nejkrat¹í prodlevy je dosa¾eno pøi N=1. Nejkrat¹í prodleva je tedy
(3+M)T, do èeho¾ jsou rovnì¾ zapoèítány operace nastavování èi ètení
vstupnì-výstupní linky sbìrnice.
</p>
<p>Toto je také hlavním omezujícím prvkem podexu, postaveného na
mikroprocesoru. Podex se stávajícími smyèkami, které, øekl bych, u¾
nejdou (u AVR) pøi zachování promìnného èasování zkrátit, by mìl
teoreticky pracovat zhruba do frekvence BDM 120% frekvence vlastního
jednoèipu AVR.
</p>


<a name="3-3"></a><h2>Popis programu</h2>

<p>Zdrojový kód firmwaru podexu je v assembleru procesorù Atmel AVR (v
malé variantì pro AT90S2313).
</p>
<p>V úvodu jsou definovány èíselné konstanty, zejména POD_XTAL_640A a
POD_XTAL_640B, pro nì¾ by mìlo platit, ¾e podíl
POD_XTAL_640A/POD_XTAL_640B je roven frekvenci krystalu podexu dìlené
640MHz. Tyto konstanty jsou pou¾ity pro výpoèet èasování smyèek
celoèíselnou aritmetikou z hodnoty 128EClocks, udávané pøíkazem
EtendedSpeed. Následuje konstanta BAUD_RATE, z ní¾ je ji¾ pøi kompilaci
urèena hodnota UBRR pro stanovení rychlosti asynchronního sériového
pøenosu RS232.
</p>
<p>Dále je definováno umístìní promìnných v pamìti AVR, a sice
REG_BASE_HI (viz SetRegisterBase), PACE_COUNT, RESET_COUNT (viz
SetParam), SPEED, XSPEED_* (rychlosti dle SetParam a ExtendedSpeed),
8bitové èasovací konstanty WAIT_BDM* pro vysílání/pøíjem bitù BDM a
16bitové èsovací konstanty WAIT_*, urèené pro nezbytné prodlevy pro
vykonání BDM pøíkazù. Následuje výèet operaèních kódù BDM i ostatních
pøíkazù protokolu podexu.
</p>
<p>Podex pracuje bez pou¾ití pøeru¹ení, tabulka vektorù obsahuje jen
hluchou výplò. Po spu¹tìní AVR je nastaven zásobník, vstupnì-výstupní
brána, sériové rozhraní, implicitní frekvence BDM 8MHz. Po tomto
nastavení pøechází podex do hlavní smyèky. Na poèátku hlavní smyèky
èeká podex na pøíjem slabiky z øídicího poèítaèe a dále se program
vìtví podle jejího obsahu. Poøadì jsou obslou¾eny:
</p>
<ul>
<li>jednoslabièný hardwarový pøíkaz BDM (pøipadá v úvahu jen
BACKGROUND), následovaný pøedepsanou prodlevou 150E</li>
<li>jednoslabièné firmwarové pøíkazy BDM, následované pøedepsanou
prodlevou 64E</li>
<li>hardwarové pøíkazy BDM s dvìma slabikami adresy a dvìma slabikami
dat, obsluhované procedurami hw_read_cmd, hw_write_cmd</li>
<li>firmwarové pøíkazy BDM s dvìma slabikami dat, obsluhované
procedurami fw_read_cmd, fw_write_cmd</li>
<li>pøíkazy s jednoslabièným operaèním kódem
    <ul>
<li>Reset</li>
<li>ResetLOW</li>
<li>ResetHIGH</li>
<li>EEPROMWrite -- pou¾ívá registr HC12 EEPROG, v pøípadì, ¾e
jednièkové bity, obsa¾ené v novì programovaném slovu, jsou ve
stávajícím slovu na dané adrese ji¾ obsa¾eny, nema¾e slovo, pouze
doprogramuje zbývající jednièkové bity</li>
<li>SetRegisterBase</li>
<li>BulkEraseEEPROM</li>
<li>Sync -- nejhezèí pøíkaz roku</li>
</ul>
  </li>
<li>pøíkazy s dvouslabièným operaèním kódem (první slabika je 0x04,
nazývají se "roz¹íøené")
    <ul>
<li>Version -- druhý nejhezèí pøíkaz roku</li>
<li>RegisterDump -- volá proceduru reg_dump</li>
<li>TraceTo -- nejo¹klivìj¹í pøíkaz století, navíc neznám jeho
správné chování; pou¾ívá rovnì¾ proceduru reg_dump</li>
<li>MemDump</li>
<li>SetParam -- i v pøípadì, ¾e je u¾ivatelem zvolena jedna z
frekvencí BDM 1, 2, 4, 8 MHz, je proveden výpoèet èasovacích konstant z
hodnoty 128EClocks = (1280/F - 14)/8, kde F jsou frekvence v MHz;
výpoèet èasovacích konstant provádí procedura set_speed z promìnné
XSPEED_*, do ní¾ je ulo¾ena hodnota 128EClocks</li>
<li>MemPut</li>
<li>ExtendedSpeed -- nastaví promìnnou XSPEED_* a volá proceduru
set_speed</li>
</ul>
  </li>
</ul>
<p>V pøípadì, ¾e první pøijatá slabika není operaèním kódem ¾ádného
pøíkazu, je rozsvícena èervená dioda a èeká se na dal¹í pøíkaz. V
pøípadì, ¾e byl úspì¹nì dokonèen existující pøíkaz, je èervená dioda
zhasnuta. Po dobu èekání na pøíkaz (první slabiku) svítí zelená dioda,
po dobu vykonávání pøíkazu je zhasnuta.
</p>
<p>V kódu následují rùzné procedury, vyu¾ívané pøi obsluze pøíkazù:
</p>
<ul>
<li>reg_dump -- po¹le obsah registrù øídicímu poèítaèi; k tomu
potøebuje, aby byla HC12 ve stavu s aktivním BDM -- pøedpokládám, ¾e
tento stav je ji¾ pøedem zapnut øídicím poèítaèem; obsah stavového
registru HC12 CCR je èten z jeho zálohy v BDM registru CCR_SAVE (0xff06)</li>
<li>pod_rx_addrcount -- pøijme adresu a poèet slov od øídicího
poèítaèe, slou¾í pøíkazùm MemDump a MemPut</li>
<li>eeprom_write -- ma¾e nebo programuje EEPROM HC12</li>
<li>set_speed --
    <blockquote><table border="1" cellspacing="0" cellpadding="3"><tr><td><pre>tady se musím trochu rozepsat o poèítání èasovacích smyèek...</pre></td></tr></table></blockquote>
    <ul><li>comp_delay</li></ul>
  </li>
<li>hw_read_cmd, hw_write_cmd, fw_read_cmd, fw_write_cmd -- provádìjí
hardwarové a firmwarové pøíkazy ètení a zápisu dat vèetnì pøedepsaných
prodlev -- volány z vìt¹iny pøíkazù
  </li>
<li>pod_rx_word, pod_tx_word -- zkratky pro pøíjem/vyslání 16bitového
èísla mezi podexem a øídicím poèítaèem</li>
<li>pod_rx(__) -- pøíjem slabiky z øídicího poèítaèe dle popsaného
potvrzovacího rituálu RTS, CTS</li>
<li>pod_tx -- vyslání slabiky øídicímu poèítaèi (obejde se bez tance
s RTS, CTS)</li>
<li>bdm_rx, bdm_tx -- pøíjem/vyslání slabiky na BDM, volá 8x
proceduru pro zpracování jednoho bitu</li>
<li>bdm_rx_bit, bdm_tx_bit -- pøíjem/vyslání jednoho bitu na BDM s
pou¾itím 8bitových èasovacích konstant v RAM, vypoètených procedurou
set_speed</li>
<li>wait_*E -- pøedepsané prodlevy pro vykonání pøíkazù BDM,
pou¾ívající 16bitové èasovací konstanty v RAM, vypoètené procedurou
set_speed</li>
<li>mul24u8 -- celoèíselné násobení bez znaménka 24bitového èísla
8bitovým s ulo¾ením výsledku do 24bitù -- pou¾íváno procedurou set_speed
  </li>
<li>div24u24 -- 24bitové dìlení se zbytkem bez znaménka -- pou¾íváno
procedurou set_speed</li>
</ul>

<p></p>
<br><hr size="1">
<table border="0" width="100%"><tr>
<td align="left"><em>Podex -- rozhraní 68HC12 BDM</em></td>
<td align="center"><a href="http://duch.cz/podex/">http://duch.cz/podex/</a></td>
<td align="right">
<em>Marek Peca,</em> &lt;<a href="mailto:marek@duch.cz">marek@duch.cz</a>&gt;</td>
</tr></table>
</body>
</html>
